name: Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "staging or production"
        required: true
        default: "staging"
      deployment:
        description: "Deployment name (e.g., credit-backend)"
        required: true
        default: "credit-backend"

env:
  NAMESPACE: credit-scoring

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare kubeconfig
        run: |
          mkdir -p ~/.kube
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            echo "${{ secrets.KUBECONFIG_PRODUCTION_B64 }}" | base64 -d > ~/.kube/config
          else
            echo "${{ secrets.KUBECONFIG_STAGING_B64 }}" | base64 -d > ~/.kube/config
          fi

      - name: Rollback deployment
        run: |
          kubectl -n $NAMESPACE rollout undo deployment/${{ github.event.inputs.deployment }}
          kubectl -n $NAMESPACE rollout status deployment/${{ github.event.inputs.deployment }} --timeout=240s
